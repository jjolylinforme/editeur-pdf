<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Éditeur PDF Avancé</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">

<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-8">
  <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Éditeur PDF Avancé</h1>
  <p class="text-center text-gray-600 mb-8">Masquez, déplacez et redimensionnez des zones sur votre PDF</p>

  <div id="upload-zone" class="border-2 border-dashed border-indigo-300 rounded-xl p-12 text-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-all">
    <p class="text-lg font-medium text-gray-700 mb-2">Cliquez pour charger votre PDF</p>
    <p class="text-sm text-gray-500">Le fichier reste sur votre ordinateur</p>
    <input type="file" id="pdfInput" accept=".pdf" class="hidden">
  </div>

  <div id="viewer" class="hidden mt-8">
    <div class="flex justify-between mb-2">
      <button id="prevPage" class="bg-gray-200 px-3 py-1 rounded">←</button>
      <span id="pageInfo" class="text-gray-700"></span>
      <button id="nextPage" class="bg-gray-200 px-3 py-1 rounded">→</button>
    </div>

    <div class="bg-white rounded-lg overflow-auto flex justify-center" style="max-height:600px;">
      <div style="position: relative;">
        <canvas id="pdfCanvas"></canvas>
        <canvas id="overlayCanvas" style="position:absolute;top:0;left:0;cursor:crosshair;"></canvas>
      </div>
    </div>

    <div class="flex items-center gap-4 mt-4 flex-wrap">
      <label class="flex items-center cursor-pointer">
        <input type="checkbox" id="applyToAll" checked class="w-4 h-4 text-indigo-600 rounded mr-2">
        <span class="text-sm text-gray-700">Appliquer les zones de la page 1 à toutes les pages</span>
      </label>
    </div>

    <div class="flex gap-2 mt-4 flex-wrap">
      <button id="deleteZone" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">Supprimer zone sélectionnée</button>
      <button id="clearPageZones" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm">Effacer page courante</button>
      <button id="clearAllZones" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">Tout effacer</button>
    </div>

    <button id="downloadPDF" class="w-full py-4 mt-4 rounded-xl font-semibold text-white bg-indigo-600 hover:bg-indigo-700 shadow-lg flex items-center justify-center">Télécharger PDF modifié</button>
  </div>
</div>

<script>
const pdfInput = document.getElementById('pdfInput');
const uploadZone = document.getElementById('upload-zone');
const viewer = document.getElementById('viewer');
const pdfCanvas = document.getElementById('pdfCanvas');
const overlayCanvas = document.getElementById('overlayCanvas');
const overlayCtx = overlayCanvas.getContext('2d');
const prevPageBtn = document.getElementById('prevPage');
const nextPageBtn = document.getElementById('nextPage');
const pageInfo = document.getElementById('pageInfo');
const applyToAllCheckbox = document.getElementById('applyToAll');
const deleteBtn = document.getElementById('deleteZone');
const clearPageBtn = document.getElementById('clearPageZones');
const clearAllBtn = document.getElementById('clearAllZones');
const downloadBtn = document.getElementById('downloadPDF');

let pdfDoc = null;
let pdfFile = null;
let currentPage = 1;
let totalPages = 0;
let scale = 1.5;

let zones = {};
let selectedZone = null;

let isDrawing = false;
let isDragging = false;
let isResizing = false;
let startX = 0, startY = 0, offsetX = 0, offsetY = 0;
let resizeHandle = null;
let currentRect = null;

uploadZone.addEventListener('click', () => pdfInput.click());
pdfInput.addEventListener('change', handleFileUpload);

async function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file || file.type !== 'application/pdf') return;
  pdfFile = file;
  const arrayBuffer = await file.arrayBuffer();
  const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
  pdfDoc = await loadingTask.promise;
  totalPages = pdfDoc.numPages;
  viewer.classList.remove('hidden');
  uploadZone.classList.add('hidden');
  currentPage = 1;
  renderPage(currentPage);
}

async function renderPage(num) {
  const page = await pdfDoc.getPage(num);
  const viewport = page.getViewport({ scale });
  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;
  overlayCanvas.width = viewport.width;
  overlayCanvas.height = viewport.height;
  await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport }).promise;
  drawZones();
  pageInfo.textContent = `Page ${num}/${totalPages}`;
}

function drawZones() {
  overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
  const pageZones = zones[currentPage] || [];
  pageZones.forEach(z => {
    overlayCtx.fillStyle = z === selectedZone ? 'rgba(59,130,246,0.3)' : 'rgba(239,68,68,0.3)';
    overlayCtx.fillRect(z.x, z.y, z.w, z.h);
    overlayCtx.strokeStyle = z === selectedZone ? 'rgba(59,130,246,0.8)' : 'rgba(239,68,68,0.8)';
    overlayCtx.lineWidth = z === selectedZone ? 2 : 1;
    overlayCtx.strokeRect(z.x, z.y, z.w, z.h);
  });
}

function getMousePos(e) {
  const rect = overlayCanvas.getBoundingClientRect();
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

overlayCanvas.addEventListener('mousedown', e => {
  const { x, y } = getMousePos(e);
  const pageZones = zones[currentPage] || [];

  // Vérifie si on clique sur une zone pour la déplacer ou redimensionner
  let clickedZone = null;
  for (let i = pageZones.length -1; i >=0; i--) {
    const z = pageZones[i];
    if (x >= z.x && x <= z.x + z.w && y >= z.y && y <= z.y + z.h) {
      clickedZone = z;
      break;
    }
  }

  if (clickedZone) {
    selectedZone = clickedZone;
    isDragging = true;
    offsetX = x - selectedZone.x;
    offsetY = y - selectedZone.y;
  } else {
    selectedZone = null;
    isDrawing = true;
    startX = x; startY = y;
    currentRect = { x, y, w:0, h:0 };
    if (!zones[currentPage]) zones[currentPage] = [];
  }
  drawZones();
});

overlayCanvas.addEventListener('mousemove', e => {
  const { x, y } = getMousePos(e);
  if (isDrawing) {
    currentRect.w = x - startX;
    currentRect.h = y - startY;
    drawZones();
    overlayCtx.fillStyle = 'rgba(239,68,68,0.3)';
    overlayCtx.fillRect(Math.min(startX,x), Math.min(startY,y), Math.abs(currentRect.w), Math.abs(currentRect.h));
    overlayCtx.strokeStyle = 'rgba(239,68,68,0.8)';
    overlayCtx.strokeRect(Math.min(startX,x), Math.min(startY,y), Math.abs(currentRect.w), Math.abs(currentRect.h));
  }
  if (isDragging && selectedZone) {
    selectedZone.x = x - offsetX;
    selectedZone.y = y - offsetY;
    drawZones();
  }
});

overlayCanvas.addEventListener('mouseup', e => {
  if (isDrawing) {
    currentRect.w = Math.abs(currentRect.w);
    currentRect.h = Math.abs(currentRect.h);
    zones[currentPage].push(currentRect);
    selectedZone = currentRect;
    currentRect = null;
    isDrawing = false;
  }
  isDragging = false;
  drawZones();
});

deleteBtn.addEventListener('click', () => {
  if (!selectedZone) return;
  zones[currentPage] = zones[currentPage].filter(z => z !== selectedZone);
  selectedZone = null;
  drawZones();
});

clearPageBtn.addEventListener('click', () => {
  delete zones[currentPage];
  selectedZone = null;
  drawZones();
});

clearAllBtn.addEventListener('click', () => {
  zones = {};
  selectedZone = null;
  drawZones();
});

prevPageBtn.addEventListener('click', () => {
  if (currentPage > 1) { currentPage--; selectedZone=null; renderPage(currentPage);}
});
nextPageBtn.addEventListener('click', () => {
  if (currentPage < totalPages) { currentPage++; selectedZone=null; renderPage(currentPage);}
});

downloadBtn.addEventListener('click', async () => {
  if (!pdfFile) return;
  const { PDFDocument, rgb } = PDFLib;
  const arrayBuffer = await pdfFile.arrayBuffer();
  const pdf = await PDFDocument.load(arrayBuffer);
  const pages = pdf.getPages();

  for (let i=0;i<pages.length;i++){
    const page = pages[i];
    const { width, height } = page.getSize();
    let zonesToApply = [];
    if (applyToAllCheckbox.checked && zones[1]) zonesToApply = zones[1];
    else if (zones[i+1]) zonesToApply = zones[i+1];
    zonesToApply.forEach(z => {
      const pdfY = height - z.y/scale - z.h/scale;
      page.drawRectangle({
        x: z.x/scale,
        y: pdfY,
        width: z.w/scale,
        height: z.h/scale,
        color: rgb(1,1,1),
      });
    });
  }
  const pdfBytes = await pdf.save();
  const blob = new Blob([pdfBytes], {type:'application/pdf'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = pdfFile.name.replace('.pdf','')+'_modifie.pdf';
  link.click();
});
</script>
</body>
</html>
