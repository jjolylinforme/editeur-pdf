<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Effaceur PDF S√©curis√© (D√©finitif)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen p-6">

<div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
  <div class="flex flex-col items-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800 tracking-tight">üßº Effaceur PDF S√©curis√©</h1>
    <p class="text-gray-500 mt-2 text-center max-w-lg">
        Les zones blanches suppriment d√©finitivement le contenu. <br>
        Le fichier est "aplati" pour emp√™cher toute r√©cup√©ration des donn√©es cach√©es.
    </p>
  </div>

  <div id="upload-zone" class="border-4 border-dashed border-blue-200 rounded-2xl p-20 text-center cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition-all group">
    <div class="text-blue-400 group-hover:scale-110 transition-transform mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor font-sans"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
    </div>
    <p class="text-xl font-semibold text-gray-700">Cliquez pour importer votre PDF</p>
    <input type="file" id="pdfInput" accept=".pdf" class="hidden">
  </div>

  <div id="viewer" class="hidden space-y-6">
    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-xl border border-gray-100 shadow-sm">
      <div class="flex gap-2">
        <button id="prevPage" class="bg-white hover:bg-blue-600 hover:text-white px-4 py-2 rounded-lg border shadow-sm transition-all font-bold">‚Üê</button>
        <button id="nextPage" class="bg-white hover:bg-blue-600 hover:text-white px-4 py-2 rounded-lg border shadow-sm transition-all font-bold">‚Üí</button>
      </div>
      <div id="pageInfo" class="font-bold text-blue-700 bg-blue-50 px-4 py-2 rounded-full border border-blue-100 shadow-inner italic">Page 1/1</div>
    </div>

    <div class="bg-gray-300 rounded-xl overflow-auto flex justify-center p-4 border-2 border-gray-100 shadow-inner" style="max-height:60vh;">
      <div class="relative bg-white shadow-2xl leading-[0]">
        <canvas id="pdfCanvas"></canvas>
        <canvas id="overlayCanvas" class="absolute top-0 left-0"></canvas>
      </div>
    </div>

    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-4">
        <label class="flex items-center cursor-pointer group">
          <input type="checkbox" id="applyToAll" checked class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 transition-all cursor-pointer">
          <span class="ml-3 text-sm font-semibold text-gray-700 group-hover:text-blue-800">Appliquer cet effacement sur l'ensemble du document</span>
        </label>
        
        <button id="downloadPDF" class="w-full py-5 rounded-xl font-black text-white bg-blue-600 hover:bg-blue-700 shadow-xl flex items-center justify-center gap-3 transition-all transform hover:-translate-y-1 active:scale-95 uppercase tracking-widest text-lg">
            <span>üõ°Ô∏è T√©l√©charger</span>
        </button>
  
    </div>
  </div>
</div>

<script>
const pdfInput = document.getElementById('pdfInput'), uploadZone = document.getElementById('upload-zone'), viewer = document.getElementById('viewer');
const pdfCanvas = document.getElementById('pdfCanvas'), overlayCanvas = document.getElementById('overlayCanvas'), overlayCtx = overlayCanvas.getContext('2d');
const prevPageBtn = document.getElementById('prevPage'), nextPageBtn = document.getElementById('nextPage'), pageInfo = document.getElementById('pageInfo');
const applyToAllCheckbox = document.getElementById('applyToAll'), downloadBtn = document.getElementById('downloadPDF');

let pdfDoc = null, pdfFile = null, currentPage = 1, totalPages = 0, scale = 1.5;
let zones = {}, isDrawing = false, isDragging = false, startX, startY, offX, offY, activeZone;

uploadZone.onclick = () => pdfInput.click();
pdfInput.onchange = async (e) => {
  const file = e.target.files[0]; if (!file) return;
  pdfFile = file;
  pdfDoc = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
  totalPages = pdfDoc.numPages;
  viewer.classList.remove('hidden'); uploadZone.classList.add('hidden');
  renderPage(1);
};

async function renderPage(num) {
  const page = await pdfDoc.getPage(num);
  const viewport = page.getViewport({ scale });
  pdfCanvas.width = overlayCanvas.width = viewport.width;
  pdfCanvas.height = overlayCanvas.height = viewport.height;
  await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport }).promise;
  draw();
  pageInfo.textContent = `Page ${num} / ${totalPages}`;
}

function draw() {
  overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
  (zones[currentPage] || []).forEach(z => {
    overlayCtx.fillStyle = 'white';
    overlayCtx.shadowBlur = 4; overlayCtx.shadowColor = 'rgba(0,0,0,0.1)';
    overlayCtx.fillRect(z.x, z.y, z.w, z.h);
    overlayCtx.shadowBlur = 0;
    overlayCtx.strokeStyle = '#3b82f6';
    overlayCtx.strokeRect(z.x, z.y, z.w, z.h);
    overlayCtx.fillStyle = '#ef4444'; overlayCtx.fillRect(z.x + z.w - 20, z.y, 20, 20);
    overlayCtx.fillStyle = 'white'; overlayCtx.font = 'bold 14px Arial'; overlayCtx.fillText('√ó', z.x + z.w - 15, z.y + 15);
  });
}

const getPos = (e) => { const r = overlayCanvas.getBoundingClientRect(); return { x: e.clientX - r.left, y: e.clientY - r.top }; };

overlayCanvas.onmousedown = e => {
  const { x, y } = getPos(e);
  const pageZones = zones[currentPage] || [];
  const delIdx = pageZones.findIndex(z => x >= z.x+z.w-20 && x <= z.x+z.w && y >= z.y && y <= z.y+20);
  if (delIdx !== -1) { zones[currentPage].splice(delIdx, 1); draw(); return; }

  const moveIdx = pageZones.find(z => x >= z.x && x <= z.x+z.w && y >= z.y && y <= z.y+z.h);
  if (moveIdx) { activeZone = moveIdx; isDragging = true; offX = x-activeZone.x; offY = y-activeZone.y; }
  else { isDrawing = true; startX = x; startY = y; activeZone = {x, y, w:0, h:0}; if(!zones[currentPage]) zones[currentPage] = []; }
};

overlayCanvas.onmousemove = e => {
  const { x, y } = getPos(e);
  if (isDrawing) { activeZone.w = x-startX; activeZone.h = y-startY; draw(); overlayCtx.strokeStyle = '#3b82f6'; overlayCtx.strokeRect(startX, startY, activeZone.w, activeZone.h); }
  else if (isDragging) { activeZone.x = x-offX; activeZone.y = y-offY; draw(); }
  else { 
    const isOver = (zones[currentPage] || []).some(z => x >= z.x && x <= z.x+z.w && y >= z.y && y <= z.y+z.h);
    overlayCanvas.style.cursor = isOver ? 'move' : 'crosshair';
  }
};

window.onmouseup = () => {
  if (isDrawing && Math.abs(activeZone.w) > 5) {
    zones[currentPage].push({ x: activeZone.w>0?activeZone.x:activeZone.x+activeZone.w, y: activeZone.h>0?activeZone.y:activeZone.y+activeZone.h, w: Math.abs(activeZone.w), h: Math.abs(activeZone.h) });
  }
  isDrawing = isDragging = false; activeZone = null; draw();
};

prevPageBtn.onclick = () => { if(currentPage > 1) renderPage(--currentPage); };
nextPageBtn.onclick = () => { if(currentPage < totalPages) renderPage(++currentPage); };

downloadBtn.onclick = async () => {
  downloadBtn.innerText = "S√âCURISATION EN COURS...";
  downloadBtn.disabled = true;
  
  const { PDFDocument } = PDFLib;
  const finalPdf = await PDFDocument.create();
  
  for(let i=1; i<=totalPages; i++) {
    const page = await pdfDoc.getPage(i);
    const v = page.getViewport({ scale: 2.0 }); // Haute r√©solution pour ne pas perdre en qualit√©
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = v.width; canvas.height = v.height;
    
    await page.render({ canvasContext: ctx, viewport: v }).promise;
    
    const zs = (applyToAllCheckbox.checked && zones[1]) ? zones[1] : (zones[i] || []);
    zs.forEach(z => {
      // On dessine le blanc DIRECTEMENT sur l'image de la page
      ctx.fillStyle = 'white';
      ctx.fillRect(z.x * (v.width/overlayCanvas.width), z.y * (v.height/overlayCanvas.height), z.w * (v.width/overlayCanvas.width), z.h * (v.height/overlayCanvas.height));
    });
    
    const imgData = canvas.toDataURL('image/jpeg', 0.9);
    const img = await finalPdf.embedJpg(imgData);
    const newPage = finalPdf.addPage([v.width, v.height]);
    newPage.drawImage(img, { x: 0, y: 0, width: v.width, height: v.height });
  }

  const blob = new Blob([await finalPdf.save()], {type:'application/pdf'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `SECURISE_${pdfFile.name}`;
  link.click();
  
  downloadBtn.innerText = "üõ°Ô∏è Finaliser et T√©l√©charger";
  downloadBtn.disabled = false;
};
</script>
</body>
</html>
